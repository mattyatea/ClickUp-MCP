---
description: ClickUp API çµ±åˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
globs: ["src/api/**/*.ts", "src/auth/**/*.ts"]
alwaysApply: true
---

# ClickUp API çµ±åˆã‚¬ã‚¤ãƒ‰

## ğŸ—ï¸ ç¾åœ¨ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. çµ±åˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (`src/api/index.ts`)
```typescript
export class ClickUpClient {
  constructor(private deps: ServiceDependencies) {
    this.auth = new ClickUpAuth(deps);
    this.taskBasic = new ClickUpTaskBasic(deps);
    this.taskSearch = new ClickUpTaskSearch(deps);
    this.formatters = new DataFormatters(deps);
  }

  // å…¬é–‹ãƒ¡ã‚½ãƒƒãƒ‰
  async getUserInfo(accessToken: string) {
    return this.auth.getUserInfo(accessToken);
  }

  async getTask(accessToken: string, taskId: string) {
    const rawData = await this.taskBasic.getTask(accessToken, taskId);
    return this.formatters.formatTaskData(rawData);
  }
}
```

### 2. æ©Ÿèƒ½åˆ¥APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `ClickUpAuth` - èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
- `ClickUpTaskBasic` - ã‚¿ã‚¹ã‚¯åŸºæœ¬æ“ä½œ
- `ClickUpTaskSearch` - ã‚¿ã‚¹ã‚¯æ¤œç´¢
- `DataFormatters` - ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°

### 3. å…±é€šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
// src/api/common/error-handler.ts
export function createSuccessResponse(data: any): Response {
  return new Response(JSON.stringify(data), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}

export function createErrorResponse(error: string, statusCode: number = 500): Response {
  return new Response(JSON.stringify({ error }), {
    status: statusCode,
    headers: { "Content-Type": "application/json" }
  });
}
```

## ğŸŒ ä¸»è¦APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
```typescript
// GET /user
const userInfo = await fetch('https://api.clickup.com/api/v2/user', {
  headers: { 'Authorization': `Bearer ${accessToken}` }
});
```

### ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
```typescript
// GET /team
const workspaces = await fetch('https://api.clickup.com/api/v2/team', {
  headers: { 'Authorization': `Bearer ${accessToken}` }
});
```

### ã‚¿ã‚¹ã‚¯æ“ä½œ
```typescript
// GET /task/{task_id}
const task = await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
  headers: { 'Authorization': `Bearer ${accessToken}` }
});

// PUT /task/{task_id}
const updatedTask = await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
  method: 'PUT',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(updates)
});
```

### ã‚¿ã‚¹ã‚¯æ¤œç´¢
```typescript
// GET /team/{team_id}/task
const tasks = await fetch(`https://api.clickup.com/api/v2/team/${teamId}/task`, {
  headers: { 'Authorization': `Bearer ${accessToken}` }
});
```

## ğŸ” è©³ç´°æ¤œç´¢å®Ÿè£…

### ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ
```typescript
export interface AdvancedSearchFilters {
  // åŸºæœ¬æ¤œç´¢
  searchTerm: string;
  teamId: string;
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  statuses: string[];
  
  // å„ªå…ˆåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼  
  priorities: ('urgent' | 'high' | 'normal' | 'low')[];
  
  // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  assignees: string[];
  
  // æ—¥ä»˜ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  dueDateFrom?: string;
  dueDateTo?: string;
  
  // ãã®ä»–
  tags: string[];
  customFields: Record<string, any>;
  subtasks: boolean;
  archived: boolean;
  
  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
  page: number;
  limit: number;
}
```

### å„ªå…ˆåº¦ãƒãƒƒãƒ”ãƒ³ã‚°
```typescript
export const PRIORITIES = {
  urgent: 1,
  high: 2,
  normal: 3,
  low: 4
} as const;

function createPriorityFilter(priorities: ('urgent' | 'high' | 'normal' | 'low')[]): number[] {
  return priorities.map(p => PRIORITIES[p]);
}
```

## ğŸ“Š ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ
- 1åˆ†é–“ã«100ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
- 429ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- é©åˆ‡ãªãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹

```typescript
async function apiCallWithRetry<T>(
  apiCall: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await apiCall();
    } catch (error) {
      if (error instanceof Error && error.message.includes('429') && attempt < maxRetries) {
        const delay = Math.pow(2, attempt) * 1000; // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      throw error;
    }
  }
  throw new Error('æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸ');
}
```

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
async function safeApiCall<T>(
  url: string,
  options: RequestInit,
  accessToken: string
): Promise<T> {
  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
      } else if (response.status === 429) {
        throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„');
      } else if (response.status === 404) {
        throw new Error('ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
      throw new Error(`APIå‘¼ã³å‡ºã—å¤±æ•—: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    throw new Error(`ClickUp API ã‚¨ãƒ©ãƒ¼: ${error instanceof Error ? error.message : String(error)}`);
  }
}
```

## ğŸ¨ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼

### æ±ç”¨çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
```typescript
export class DataFormatters {
  constructor(private deps: ServiceDependencies) {}

  /**
   * ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
   */
  formatTimestamp(timestamp: string | number | null): string | null {
    if (!timestamp) return null;
    
    const date = new Date(typeof timestamp === 'string' ? parseInt(timestamp) : timestamp);
    if (isNaN(date.getTime())) return null;
    
    return date.toLocaleString('ja-JP', {
      timeZone: 'Asia/Tokyo',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  /**
   * ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº–å½¢å¼ã«å¤‰æ›
   */
  formatTaskData(task: any): any {
    return {
      // åŸºæœ¬æƒ…å ±
      id: task.id,
      name: task.name,
      description: task.description || null,
      status: task.status?.status || 'ä¸æ˜',
      
      // æ—¥ä»˜æƒ…å ±ï¼ˆäººé–“ãŒèª­ã‚ã‚‹å½¢å¼ï¼‰
      created_at: this.formatTimestamp(task.date_created),
      updated_at: this.formatTimestamp(task.date_updated),
      due_date: this.formatTimestamp(task.due_date),
      start_date: this.formatTimestamp(task.start_date),
      
      // æ‹…å½“è€…æƒ…å ±
      assignees: task.assignees?.map((assignee: any) => ({
        id: assignee.id,
        username: assignee.username,
        email: assignee.email
      })) || [],
      
      // ã‚¿ã‚°
      tags: task.tags?.map((tag: any) => tag.name) || [],
      
      // URL
      url: task.url || null,
      
      // å„ªå…ˆåº¦
      priority: task.priority?.priority || null,
      
      // æ‰€å±æƒ…å ±
      space: task.space ? {
        id: task.space.id,
        name: task.space.name
      } : null,
      
      folder: task.folder ? {
        id: task.folder.id,
        name: task.folder.name
      } : null,
      
      list: task.list ? {
        id: task.list.id,
        name: task.list.name
      } : null
    };
  }

  /**
   * å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¸¦åˆ—å‡¦ç†
   */
  async fetchTasksByIds(
    accessToken: string,
    taskIds: string[],
    page: number = 0,
    limit: number = 15
  ) {
    const paginatedIds = taskIds.slice(page * limit, (page + 1) * limit);
    
    const taskPromises = paginatedIds.map(async (taskId: string) => {
      try {
        const response = await fetch(`https://api.clickup.com/api/v2/task/${taskId}`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        
        if (response.ok) {
          const task = await response.json();
          return this.formatTaskData(task);
        }
        return null;
      } catch (error) {
        console.warn(`ã‚¿ã‚¹ã‚¯ID ${taskId} ã®å–å¾—ã«å¤±æ•—:`, error);
        return null;
      }
    });
    
    const results = (await Promise.all(taskPromises)).filter(task => task !== null);
    return { tasks: results, total: taskIds.length };
  }
}
```

## ğŸ”§ è¨­å®šå®šæ•°
```typescript
// src/config.ts
export const CLICKUP_CONFIG = {
  authorizeUrl: 'https://app.clickup.com/api',
  tokenUrl: 'https://api.clickup.com/api/v2/oauth/token',
  userInfoUrl: 'https://api.clickup.com/api/v2/user',
  apiBaseUrl: 'https://api.clickup.com/api/v2',
  rateLimitPerMinute: 100,
  timeoutMs: 30000
} as const;
```

## ğŸ” OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼

### ã‚¹ã‚³ãƒ¼ãƒ—è¨­å®š
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã§ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚¹ãƒšãƒ¼ã‚¹ã€ãƒ•ã‚©ãƒ«ãƒ€ã€ãƒªã‚¹ãƒˆã€ã‚¿ã‚¹ã‚¯ã¸ã®èª­ã¿æ›¸ãã‚¢ã‚¯ã‚»ã‚¹
- æ™‚é–“è¿½è·¡ã‚¨ãƒ³ãƒˆãƒªã®ä½œæˆã¨ç®¡ç†ç”¨ã®æ™‚é–“è¿½è·¡æ¨©é™ã‚’å«ã‚€

### èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
```typescript
// èªè¨¼é–‹å§‹
app.get("/authorize", async (c) => {
  const { redirectTo } = await c.env.OAUTH_PROVIDER.initializeAuthorization({
    metadata: { label: "ClickUp Integration" },
    request: c.req.raw,
    redirectTo: getUpstreamAuthorizeUrl({
      upstream_url: "https://app.clickup.com/api",
      client_id: c.env.CLICKUP_CLIENT_ID,
      redirect_uri: `${getRequestOrigin(c.req.raw)}/callback`,
      scope: "read write"
    }),
    scope: "read write"
  });
  
  return Response.redirect(redirectTo);
});

// èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
app.get("/callback", async (c) => {
  const { code } = await c.env.OAUTH_PROVIDER.validateAuthorizationRequest(c.req.raw);
  
  const tokenResponse = await fetchUpstreamAuthToken({
    upstream_url: "https://api.clickup.com/api/v2/oauth/token",
    client_id: c.env.CLICKUP_CLIENT_ID,
    client_secret: c.env.CLICKUP_CLIENT_SECRET,
    code,
    redirect_uri: `${getRequestOrigin(c.req.raw)}/callback`,
  });
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†
  // ...
});
```

## ğŸ“‹ ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¯¾å¿œ
```typescript
// GET /list/{list_id}/field
const customFields = await fetch(`https://api.clickup.com/api/v2/list/${listId}/field`, {
  headers: { 'Authorization': `Bearer ${accessToken}` }
});
```

## ğŸŒ Webhookè¨­å®š
```typescript
// POST /team/{team_id}/webhook
const webhook = await fetch(`https://api.clickup.com/api/v2/team/${teamId}/webhook`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    endpoint: 'https://your-domain.workers.dev/webhook/clickup',
    events: ['taskCreated', 'taskUpdated', 'taskDeleted']
  })
});
```

## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ä¸¦åˆ—å‡¦ç†ã®æ´»ç”¨
```typescript
// è¤‡æ•°ã®APIã‚³ãƒ¼ãƒ«ã‚’ä¸¦åˆ—å®Ÿè¡Œ
const [userData, workspaces, myTasks] = await Promise.all([
  clickupClient.getUserInfo(accessToken),
  clickupClient.getWorkspaces(accessToken),
  clickupClient.getMyTasks(accessToken)
]);
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚ºã®æœ€é©åŒ–
```typescript
// å¿…è¦æœ€å°é™ã®æƒ…å ±ã®ã¿ã‚’è¿”ã™
function createOptimizedTaskResponse(tasks: any[]) {
  return tasks.map(task => ({
    id: task.id,
    name: task.name,
    status: task.status,
    assignees: task.assignees.map((a: any) => a.username),
    // ä¸è¦ãªå¤§ããªãƒ‡ãƒ¼ã‚¿ã¯é™¤å¤–
    // custom_fields: task.custom_fields  // ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  }));
}
```

## âœ… APIçµ±åˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã¦ã„ã‚‹
- [ ] æ©Ÿå¯†æƒ…å ±ãŒãƒ­ã‚°ã«å«ã¾ã‚Œã¦ã„ãªã„
- [ ] é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¸ã®å¯¾å¿œ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- [ ] ä¸¦åˆ—å‡¦ç†ã‚’æ´»ç”¨ã—ã¦ã„ã‚‹
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚ºãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] é©åˆ‡ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æ¤œè¨

### å“è³ª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹
- [ ] å‹å®šç¾©ãŒå³å¯†ã§ã‚ã‚‹
- [ ] é©åˆ‡ãªãƒ­ã‚°å‡ºåŠ›
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸€è²«ã—ã¦ã„ã‚‹